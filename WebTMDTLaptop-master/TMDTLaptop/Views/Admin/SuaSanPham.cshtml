@model TMDTLaptop.Models.Class.SanPham
@using TMDTLaptop.Models.Class
@{
    ViewBag.Title = "Sửa Sản Phẩm";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var specDefinitions = ViewBag.SpecDefinitions as List<ThongSoKyThuat> ?? new List<ThongSoKyThuat>();
    var specValues = ViewBag.SpecValues as List<ThongSoKyThuat> ?? new List<ThongSoKyThuat>();
    var specDict = specValues.ToDictionary(s => s.MaThongSo, s => s.GiaTri ?? string.Empty);
}

<div class="container">
    <h2 class="mt-4 mb-4">Sửa Sản Phẩm</h2>

    @using (Html.BeginForm("SuaSanPham", "Admin", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(model => model.MaSanPham)
        <div class="card">
            <div class="card-body">
                <div class="form-group">
                    @Html.LabelFor(model => model.TenSanPham)
                    @Html.TextBoxFor(model => model.TenSanPham, new { @class = "form-control" })
                    @Html.ValidationMessageFor(model => model.TenSanPham, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MoTa)
                    @Html.TextAreaFor(model => model.MoTa, new { @class = "form-control", rows = 5, @id = "editor" })
                    @Html.ValidationMessageFor(model => model.MoTa, "", new { @class = "text-danger" })
                </div>

                <script>
                    CKEDITOR.replace('editor');
                </script>

                <div class="form-group">
                    @Html.LabelFor(model => model.Gia)
                    @Html.TextBoxFor(model => model.Gia, new { @class = "form-control", type = "number", step = "0.01" })
                    @Html.ValidationMessageFor(model => model.Gia, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.SoLuong, "Số Lượng")
                    @Html.TextBoxFor(model => model.SoLuong, new { @class = "form-control", type = "number", min = "0" })
                    @Html.ValidationMessageFor(model => model.SoLuong, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.Label("Hình Ảnh Đại Diện")
                    <input type="file" name="HinhDaiDien" class="form-control" />
                    @if (!string.IsNullOrWhiteSpace(Model.HinhAnh))
                    {
                        <img src="@Url.Content("~/assets/images/product/" + Model.MaSanPham + "/" + Model.HinhAnh)" alt="Hình đại diện" style="width:120px;" class="mt-2 rounded border" />
                    }
                </div>

                <div class="form-group">
                    @Html.Label("Hình Kèm Theo")
                    <input type="file" name="HinhKemTheo" class="form-control" multiple />
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MaDanhMuc, "Danh Mục")
                    @Html.DropDownListFor(
                        model => model.MaDanhMuc,
                        new SelectList(ViewBag.DanhMuc, "MaDanhMuc", "TenDanhMuc", Model.MaDanhMuc),
                        "Chọn Danh Mục",
                        new { @class = "form-control" }
                    )
                    @Html.ValidationMessageFor(model => model.MaDanhMuc, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.MaHang, "Hãng Sản Phẩm")
                    @Html.DropDownListFor(
                        model => model.MaHang,
                        new SelectList(ViewBag.Hang, "MaHang", "TenHang", Model.MaHang),
                        "Chọn Hãng",
                        new { @class = "form-control" }
                    )
                    @Html.ValidationMessageFor(model => model.MaHang, "", new { @class = "text-danger" })
                </div>

                @if (specDefinitions.Any())
                {
                    <div class="mt-4">
                        <h5>Thông số kỹ thuật</h5>
                        <input type="hidden" name="ThongSoPayload" id="ThongSoPayload" />
                        <div class="row g-3">
                            @foreach (var spec in specDefinitions)
                            {
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        @spec.TenThongSo
                                        @if (!string.IsNullOrWhiteSpace(spec.DonVi))
                                        {
                                            <small class="text-muted">(@spec.DonVi)</small>
                                        }
                                    </label>
                                    <input type="text"
                                           class="form-control spec-input"
                                           data-id="@spec.MaThongSo"
                                           value="@(specDict.ContainsKey(spec.MaThongSo) ? specDict[spec.MaThongSo] : string.Empty)"
                                           placeholder="Nhập giá trị..." />
                                </div>
                            }
                        </div>
                        <small class="text-muted d-block mt-2">Các thông số để trống sẽ không được lưu.</small>
                    </div>
                }
                else
                {
                    <input type="hidden" name="ThongSoPayload" id="ThongSoPayload" value="[]" />
                }

                <button type="submit" class="btn btn-primary mt-3">Cập Nhật Sản Phẩm</button>
                <a href="@Url.Action("QuanLySanPham")" class="btn btn-secondary mt-3 ms-2">Hủy</a>
            </div>
        </div>
    }
</div>

@section scripts{
    <script>
        (function () {
            const form = document.querySelector("form");
            if (!form) return;
            form.addEventListener("submit", function () {
                const specs = [];
                document.querySelectorAll(".spec-input").forEach(function (input) {
                    const value = (input.value || "").trim();
                    if (value) {
                        specs.push({
                            MaThongSo: parseInt(input.dataset.id),
                            GiaTri: value
                        });
                    }
                });
                const payload = document.getElementById("ThongSoPayload");
                if (payload) {
                    payload.value = JSON.stringify(specs);
                }
            });
        })();
    </script>
}

