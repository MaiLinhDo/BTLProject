@{
    ViewBag.Title = "Quản Lý Đổi Trả";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
@using TMDTLaptop.Controllers
<div class="container">
    <h2 class="mt-4 mb-4">Quản Lý Yêu Cầu Đổi Trả</h2>
    <!-- Thanh lọc trạng thái -->
    <form class="form-inline d-flex align-items-center mb-3 gap-2" method="get" action="@Url.Action("QuanLyDoiTra")">
        <select name="status" class="form-control" style="width: 250px">
            <option value="">Tất cả trạng thái</option>
            <option value="Chờ xử lý" @(ViewBag.Status == "Chờ xử lý" ? "selected" : "")>Chờ xử lý</option>
            <option value="Đã duyệt" @(ViewBag.Status == "Đã duyệt" ? "selected" : "")>Đã duyệt</option>
            <option value="Chờ lấy hàng" @(ViewBag.Status == "Chờ lấy hàng" ? "selected" : "")>Chờ lấy hàng</option>
            <option value="Đang xử lý" @(ViewBag.Status == "Đang xử lý" ? "selected" : "")>Đang xử lý</option>
            <option value="Đã xử lý" @(ViewBag.Status == "Đã xử lý" ? "selected" : "")>Đã xử lý</option>
            <option value="Từ chối" @(ViewBag.Status == "Từ chối" ? "selected" : "")>Từ chối</option>
        </select>
        <button type="submit" class="btn btn-primary" style="width: 100px">Lọc</button>
    </form>
    <div class="card">
        <div class="card-body">
            <table class="table table-hover table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Mã Đổi Trả</th>
                        <th scope="col">Đơn Hàng</th>
                        <th scope="col">Khách Hàng</th>
                        <th scope="col">Loại Yêu Cầu</th>
                        <th scope="col">Lý Do</th>
                        <th scope="col">Ngày Tạo</th>
                        <th scope="col">Trạng Thái</th>
                        <th scope="col">Hành Động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.Returns != null)
                    {
                        foreach (var item in ViewBag.Returns)
                        {
                            <tr>
                                <td>@item.MaDoiTra</td>
                                <td><a href="@Url.Action("ChiTietDonHang", new { id = item.MaDonHang })">#@item.MaDonHang</a></td>
                                <td>@item.HoTen</td>
                                <td>
                                    <span class="badge @(item.LoaiYeuCau == "Đổi" ? "bg-info" : "bg-warning") text-white">
                                        @item.LoaiYeuCau
                                    </span>
                                </td>
                                <td>@item.LyDo</td>
                                <td>@item.NgayTao</td>
                                <td>
                                    @{
                                        string statusClass = "";
                                        string trangThai = "";
                                        if (item.TrangThai != null)
                                        {
                                            trangThai = item.TrangThai.ToString();
                                        }
                                        switch (trangThai)
                                        {
                                            case "Chờ xử lý": statusClass = "bg-warning"; break;
                                            case "Đã duyệt": statusClass = "bg-info"; break;
                                            case "Chờ lấy hàng": statusClass = "bg-primary"; break;
                                            case "Đang xử lý": statusClass = "bg-secondary"; break;
                                            case "Đã xử lý": statusClass = "bg-success"; break;
                                            case "Từ chối": statusClass = "bg-danger"; break;
                                            default: statusClass = "bg-secondary"; break;
                                        }
                                    }
                                    <span class="badge @statusClass text-white">
                                        @item.TrangThai
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-info btn-sm" onclick="viewReturnDetail(@item.MaDoiTra)">
                                            Chi tiết
                                        </button>
                                        @if (item.TrangThai == "Chờ xử lý")
                                        {
                                            <button type="button" class="btn btn-success btn-sm" onclick="updateReturnStatus(@item.MaDoiTra, 'Đã duyệt')">
                                                Duyệt
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="rejectReturn(@item.MaDoiTra)">
                                                Từ chối
                                            </button>
                                        }
                                        else if (item.TrangThai == "Đã duyệt")
                                        {
                                            <button type="button" class="btn btn-primary btn-sm" onclick="updateReturnStatus(@item.MaDoiTra, 'Chờ lấy hàng')">
                                                Chờ lấy hàng
                                            </button>
                                        }
                                        else if (item.TrangThai == "Chờ lấy hàng")
                                        {
                                            <button type="button" class="btn btn-warning btn-sm" onclick="updateReturnStatus(@item.MaDoiTra, 'Đang xử lý')">
                                                Đang xử lý
                                            </button>
                                        }
                                        else if (item.TrangThai == "Đang xử lý")
                                        {
                                            <button type="button" class="btn btn-success btn-sm" onclick="completeReturn(@item.MaDoiTra)">
                                                Hoàn tất
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
    <!-- Phân trang -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            @for (var i = 1; i <= ViewBag.TotalPages; i++)
            {
                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                    <a class="page-link" href="@Url.Action("QuanLyDoiTra", new { page = i, status = ViewBag.Status })">@i</a>
                </li>
            }
        </ul>
    </nav>
</div>
<!-- Modal Chi tiết yêu cầu đổi trả -->
<div class="modal fade" id="returnDetailModal" tabindex="-1" role="dialog" aria-labelledby="returnDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnDetailModalLabel">Chi tiết yêu cầu đổi trả</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="returnDetailContent">
                <!-- Nội dung chi tiết sẽ được load bằng AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal từ chối -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Từ chối yêu cầu đổi trả</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <div class="form-group">
                        <label for="rejectReason">Lý do từ chối:</label>
                        <textarea class="form-control" id="rejectReason" rows="3" placeholder="Nhập lý do từ chối..." required></textarea>
                    </div>
                    <input type="hidden" id="rejectReturnId" value="" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">Từ chối</button>
            </div>
        </div>
    </div>
</div>
<script>
// Hàm lấy class badge theo trạng thái
function getStatusBadgeClass(status) {
    switch(status) {
        case 'Chờ xử lý': return 'bg-warning';
        case 'Đã duyệt': return 'bg-info';
        case 'Chờ lấy hàng': return 'bg-primary';
        case 'Đang xử lý': return 'bg-secondary';
        case 'Đã xử lý': return 'bg-success';
        case 'Từ chối': return 'bg-danger';
        default: return 'bg-secondary';
    }
}
function viewReturnDetail(returnId) {
    $('#returnDetailModal').modal('show');
    $('#returnDetailContent').html('<p>Đang tải thông tin...</p>');

    // Gọi API để lấy chi tiết - returns JSON
    $.getJSON('@Url.Action("ChiTietDoiTra")?id=' + returnId, function(data) {
        if (data.success && data.returnDetail) {
            var d = data.returnDetail;
            var statusClass = getStatusBadgeClass(d.TrangThai || '');
            var loaiClass = d.LoaiYeuCau === 'Đổi' ? 'bg-info' : 'bg-warning';
            
            // Build products table with images and serial numbers
            var productsHtml = '';
            if (d.Products && d.Products.length > 0) {
                var totalAmount = 0;
                d.Products.forEach(function(p) {
                    var itemTotal = (p.Gia || 0) * (p.SoLuong || 0);
                    totalAmount += itemTotal;
                    var imgSrc = p.HinhAnh ? '/assets/images/product/' + p.MaSanPham + '/' + p.HinhAnh : '/assets/images/no-image.png';
                    
                    // Format serial numbers
                    var serialHtml = '';
                    if (p.SerialNumbers && p.SerialNumbers.length > 0) {
                        serialHtml = p.SerialNumbers.map(function(s) {
                            return '<span class="badge bg-secondary me-1 mb-1">' + s + '</span>';
                        }).join('');
                    } else {
                        serialHtml = '<small class="text-muted">Chưa có</small>';
                    }
                    
                    productsHtml += '<tr>' +
                        '<td style="width:60px"><img src="' + imgSrc + '" class="img-thumbnail" style="width:50px;height:50px;object-fit:cover" onerror="this.src=\'/assets/images/no-image.png\'"></td>' +
                        '<td><strong>' + (p.TenSanPham || 'N/A') + '</strong><br><small class="text-muted">Mã: #' + (p.MaSanPham || 'N/A') + '</small></td>' +
                        '<td><span class="badge bg-primary">' + (p.SoLuong || 0) + '</span></td>' +
                        '<td>' + serialHtml + '</td>' +
                        '<td class="text-success">' + formatNumber(p.Gia || 0) + ' đ</td>' +
                        '<td><strong class="text-danger">' + formatNumber(itemTotal) + ' đ</strong></td></tr>';
                });
                productsHtml += '<tr class="table-warning"><td colspan="5" class="text-end"><strong>Tổng tiền:</strong></td><td><strong class="text-danger">' + formatNumber(d.TongTien || 0) + ' đ</strong></td></tr>';
            } else {
                productsHtml = '<tr><td colspan="6" class="text-center text-muted">Không có sản phẩm nào</td></tr>';
            }
            
            // Build error images section
            var errorImagesHtml = '';
            if (d.HinhAnhLoi && d.HinhAnhLoi.length > 0) {
                errorImagesHtml = '<div class="card mb-3"><div class="card-header bg-info text-white"><h6 class="mb-0"><i class="fas fa-images"></i> Hình ảnh minh chứng</h6></div><div class="card-body"><div class="row">';
                d.HinhAnhLoi.forEach(function(img) {
                    var imgPath = '/assets/images/returns/' + d.MaDoiTra + '/' + img;
                    errorImagesHtml += '<div class="col-md-3 col-sm-4 col-6 mb-2">' +
                        '<a href="' + imgPath + '" target="_blank">' +
                        '<img src="' + imgPath + '" class="img-thumbnail" style="width:100%;height:100px;object-fit:cover" onerror="this.style.display=\'none\'">' +
                        '</a></div>';
                });
                errorImagesHtml += '</div><p class="text-muted mb-0 mt-2"><small>Tổng cộng: ' + d.HinhAnhLoi.length + ' hình ảnh. Click để xem phóng to.</small></p></div></div>';
            } else {
                errorImagesHtml = '<div class="card mb-3"><div class="card-header bg-info text-white"><h6 class="mb-0"><i class="fas fa-images"></i> Hình ảnh minh chứng</h6></div><div class="card-body text-center text-muted"><i class="fas fa-image" style="font-size:2rem;opacity:0.3"></i><p class="mb-0">Không có hình ảnh minh chứng</p></div></div>';
            }
            
            var actionHtml = '';
            if (d.TrangThai !== 'Đã xử lý' && d.TrangThai !== 'Từ chối') {
                if (d.TrangThai === 'Chờ xử lý') {
                    actionHtml = '<button class="btn btn-success" onclick="updateReturnStatus(' + d.MaDoiTra + ', \'Đã duyệt\')"><i class="fas fa-check"></i> Duyệt</button> ' +
                                 '<button class="btn btn-danger" onclick="rejectReturn(' + d.MaDoiTra + ')"><i class="fas fa-times"></i> Từ chối</button>';
                } else if (d.TrangThai === 'Đã duyệt') {
                    actionHtml = '<button class="btn btn-primary" onclick="updateReturnStatus(' + d.MaDoiTra + ', \'Chờ lấy hàng\')"><i class="fas fa-truck"></i> Chờ lấy hàng</button>';
                } else if (d.TrangThai === 'Chờ lấy hàng') {
                    actionHtml = '<button class="btn btn-warning" onclick="updateReturnStatus(' + d.MaDoiTra + ', \'Đang xử lý\')"><i class="fas fa-spinner"></i> Đang xử lý</button>';
                } else if (d.TrangThai === 'Đang xử lý') {
                    actionHtml = '<button class="btn btn-success" onclick="updateReturnStatus(' + d.MaDoiTra + ', \'Đã xử lý\')"><i class="fas fa-check-circle"></i> Hoàn tất</button>';
                }
            }

            var html = '<div class="row mb-3">' +
                '<div class="col-md-6"><div class="card"><div class="card-header bg-primary text-white"><h6 class="mb-0">Thông tin yêu cầu</h6></div><div class="card-body">' +
                '<p><strong>Mã đổi trả:</strong> #' + (d.MaDoiTra || 'N/A') + '</p>' +
                '<p><strong>Mã đơn hàng:</strong> #' + (d.MaDonHang || 'N/A') + '</p>' +
                '<p><strong>Loại:</strong> <span class="badge ' + loaiClass + ' text-white">' + (d.LoaiYeuCau || 'N/A') + '</span></p>' +
                '<p><strong>Ngày tạo:</strong> ' + (d.NgayTao || 'N/A') + '</p>' +
                '<p><strong>Trạng thái:</strong> <span class="badge ' + statusClass + ' text-white">' + (d.TrangThai || 'N/A') + '</span></p>' +
                '</div></div></div>' +
                '<div class="col-md-6"><div class="card"><div class="card-header bg-success text-white"><h6 class="mb-0">Thông tin khách hàng</h6></div><div class="card-body">' +
                '<p><strong>Họ tên:</strong> ' + (d.HoTen || 'N/A') + '</p>' +
                '<p><strong>SĐT:</strong> ' + (d.SoDienThoai || 'N/A') + '</p>' +
                '<p><strong>Email:</strong> ' + (d.Email || 'N/A') + '</p>' +
                '<p><strong>Địa chỉ:</strong> ' + (d.DiaChiGiaoHang || 'N/A') + '</p>' +
                '</div></div></div></div>' +
                '<div class="card mb-3"><div class="card-header bg-warning text-white"><h6 class="mb-0">Lý do đổi trả</h6></div><div class="card-body">' +
                '<p><strong>Lý do:</strong> ' + (d.LyDo || 'Không có') + '</p>' +
                '<p><strong>Mô tả:</strong> ' + (d.MoTa || 'Không có') + '</p></div></div>' +
                errorImagesHtml +
                '<div class="card mb-3"><div class="card-header bg-dark text-white"><h6 class="mb-0">Sản phẩm</h6></div><div class="card-body">' +
                '<table class="table table-hover"><thead><tr><th>Ảnh</th><th>Tên SP</th><th>SL</th><th>Serial</th><th>Đơn giá</th><th>Thành tiền</th></tr></thead><tbody>' + productsHtml + '</tbody></table></div></div>';
            
            if (actionHtml) {
                html += '<div class="card"><div class="card-header bg-secondary text-white"><h6 class="mb-0">Hành động</h6></div><div class="card-body">' + actionHtml + '</div></div>';
            }
            
            $('#returnDetailContent').html(html);
        } else {
            $('#returnDetailContent').html('<p class="text-danger">' + (data.message || 'Không thể tải thông tin chi tiết.') + '</p>');
        }
    }).fail(function() {
        $('#returnDetailContent').html('<p class="text-danger">Không thể tải thông tin chi tiết.</p>');
    });
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
// Cập nhật trạng thái đổi trả
function updateReturnStatus(returnId, newStatus) {
    if (confirm('Bạn có chắc chắn muốn cập nhật trạng thái này không?')) {
        $.post('@Url.Action("CapNhatTrangThaiDoiTra")', {
            maDoiTra: returnId,
            trangThai: newStatus
        }, function(result) {
            if (result.success) {
                alert('Cập nhật trạng thái thành công!');
                location.reload();
            } else {
                alert('Có lỗi: ' + result.message);
            }
        });
    }
}
// Hiển thị modal từ chối
function rejectReturn(returnId) {
    $('#rejectReturnId').val(returnId);
    $('#rejectReason').val('');
    $('#rejectModal').modal('show');
}
// Xác nhận từ chối
function confirmReject() {
    const returnId = $('#rejectReturnId').val();
    const reason = $('#rejectReason').val().trim();
    if (!reason) {
        alert('Vui lòng nhập lý do từ chối!');
        return;
    }
    $.post('@Url.Action("CapNhatTrangThaiDoiTra")', {
        maDoiTra: returnId,
        trangThai: 'Từ chối',
        ghiChu: reason
    }, function(result) {
        if (result.success) {
            alert('Từ chối yêu cầu thành công!');
            $('#rejectModal').modal('hide');
            location.reload();
        } else {
            alert('Có lỗi: ' + result.message);
        }
    });
}
// Hoàn tất đổi trả
function completeReturn(returnId) {
    if (confirm('Xác nhận hoàn tất xử lý đổi trả?')) {
        updateReturnStatus(returnId, 'Đã xử lý');
    }
}
</script>