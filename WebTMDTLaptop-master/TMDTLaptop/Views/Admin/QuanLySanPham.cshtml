@using System.Web
@using TMDTLaptop.Models.Class
@{
    ViewBag.Title = "Quản Lý Sản Phẩm";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var specDefinitions = ViewBag.SpecDefinitions as List<ThongSoKyThuat> ?? new List<ThongSoKyThuat>();
    var activeFilters = ViewBag.ActiveSpecFilters as IDictionary<int, string> ?? new Dictionary<int, string>();
    
    // Helper function để lấy danh sách giá trị cho từng thông số
    Func<string, List<string>> GetSpecValues = (specName) =>
    {
        var values = new List<string>();
        specName = specName.ToLower();
        
        if (specName.Contains("cpu") && !specName.Contains("tốc độ") && !specName.Contains("nhân") && !specName.Contains("luồng"))
        {
            values = new List<string> { "", "Intel Core i3", "Intel Core i5", "Intel Core i7", "Intel Core i9", "AMD Ryzen 3", "AMD Ryzen 5", "AMD Ryzen 7", "AMD Ryzen 9", "Apple M1", "Apple M2", "Apple M3" };
        }
        else if (specName.Contains("tốc độ cpu"))
        {
            values = new List<string> { "", "1.6", "1.8", "2.0", "2.2", "2.4", "2.6", "2.8", "3.0", "3.2", "3.4", "3.6", "3.8", "4.0", "4.2", "4.4", "4.6", "4.8", "5.0" };
        }
        else if (specName.Contains("số nhân cpu"))
        {
            values = new List<string> { "", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20" };
        }
        else if (specName.Contains("số luồng cpu"))
        {
            values = new List<string> { "", "4", "6", "8", "10", "12", "14", "16", "20", "24", "28", "32" };
        }
        else if (specName.Contains("ram") && !specName.Contains("loại") && !specName.Contains("tốc độ") && !specName.Contains("khe") && !specName.Contains("tối đa"))
        {
            values = new List<string> { "", "4", "8", "16", "32", "64" };
        }
        else if (specName.Contains("loại ram"))
        {
            values = new List<string> { "", "DDR4", "DDR5", "LPDDR4", "LPDDR4X", "LPDDR5", "LPDDR5X" };
        }
        else if (specName.Contains("tốc độ ram"))
        {
            values = new List<string> { "", "2133", "2400", "2666", "2933", "3200", "3600", "3733", "4266", "4800", "5200", "5600", "6000", "6400" };
        }
        else if (specName.Contains("số khe ram"))
        {
            values = new List<string> { "", "1", "2", "4" };
        }
        else if (specName.Contains("ram tối đa"))
        {
            values = new List<string> { "", "8", "16", "32", "64", "128" };
        }
        else if (specName.Contains("ổ cứng") && !specName.Contains("loại") && !specName.Contains("thứ 2"))
        {
            values = new List<string> { "", "128", "256", "512", "1024", "2048", "4096" };
        }
        else if (specName.Contains("loại ổ cứng"))
        {
            values = new List<string> { "", "SSD SATA", "SSD NVMe", "HDD", "SSD M.2", "SSD PCIe" };
        }
        else if (specName.Contains("ổ cứng thứ 2"))
        {
            values = new List<string> { "", "128", "256", "512", "1024", "2048" };
        }
        else if (specName.Contains("kích thước màn hình"))
        {
            values = new List<string> { "", "11.6", "12.5", "13.3", "14", "15.6", "16", "17.3", "18" };
        }
        else if (specName.Contains("độ phân giải"))
        {
            values = new List<string> { "", "HD (1366x768)", "HD+ (1600x900)", "Full HD (1920x1080)", "2K (2560x1440)", "4K (3840x2160)", "Retina", "OLED" };
        }
        else if (specName.Contains("công nghệ màn hình"))
        {
            values = new List<string> { "", "IPS", "OLED", "LCD", "TN", "VA", "Mini LED", "Micro LED" };
        }
        else if (specName.Contains("tần số quét"))
        {
            values = new List<string> { "", "60", "90", "120", "144", "165", "240", "300" };
        }
        else if (specName.Contains("độ sáng"))
        {
            values = new List<string> { "", "200", "250", "300", "350", "400", "450", "500", "600", "1000", "1200" };
        }
        else if (specName.Contains("card đồ họa"))
        {
            values = new List<string> { "", "Intel UHD Graphics", "Intel Iris Xe", "AMD Radeon Graphics", "NVIDIA GeForce GTX 1650", "NVIDIA GeForce RTX 3050", "NVIDIA GeForce RTX 3060", "NVIDIA GeForce RTX 3070", "NVIDIA GeForce RTX 4050", "NVIDIA GeForce RTX 4060", "NVIDIA GeForce RTX 4070", "AMD Radeon RX 6600M", "AMD Radeon RX 6700M" };
        }
        else if (specName.Contains("vram"))
        {
            values = new List<string> { "", "2", "4", "6", "8", "12", "16" };
        }
        else if (specName.Contains("dung lượng pin"))
        {
            values = new List<string> { "", "30", "40", "45", "50", "56", "60", "70", "80", "90", "100" };
        }
        else if (specName.Contains("thời lượng pin"))
        {
            values = new List<string> { "", "4", "6", "8", "10", "12", "14", "16", "18", "20" };
        }
        else if (specName.Contains("công suất sạc"))
        {
            values = new List<string> { "", "45", "65", "90", "100", "135", "180", "230" };
        }
        else if (specName.Contains("usb-c"))
        {
            values = new List<string> { "", "0", "1", "2", "3", "4" };
        }
        else if (specName.Contains("hdmi"))
        {
            values = new List<string> { "", "0", "1", "2" };
        }
        else if (specName.Contains("thunderbolt"))
        {
            values = new List<string> { "", "0", "1", "2", "3", "4" };
        }
        else if (specName.Contains("wi-fi"))
        {
            values = new List<string> { "", "Wi-Fi 5 (802.11ac)", "Wi-Fi 6 (802.11ax)", "Wi-Fi 6E", "Wi-Fi 7" };
        }
        else if (specName.Contains("bluetooth"))
        {
            values = new List<string> { "", "Bluetooth 4.0", "Bluetooth 4.2", "Bluetooth 5.0", "Bluetooth 5.1", "Bluetooth 5.2", "Bluetooth 5.3" };
        }
        else if (specName.Contains("webcam"))
        {
            values = new List<string> { "", "0.3", "0.9", "1.0", "2.0", "5.0", "8.0" };
        }
        else if (specName.Contains("trọng lượng"))
        {
            values = new List<string> { "", "0.8", "1.0", "1.2", "1.4", "1.6", "1.8", "2.0", "2.2", "2.5", "3.0" };
        }
        else if (specName.Contains("hệ điều hành"))
        {
            values = new List<string> { "", "Windows 11 Home", "Windows 11 Pro", "Windows 10 Home", "Windows 10 Pro", "macOS", "Ubuntu", "FreeDOS", "Không có OS" };
        }
        else if (specName.Contains("bảo hành"))
        {
            values = new List<string> { "", "12", "18", "24", "36", "48", "60" };
        }
        
        return values.Count > 0 ? values : new List<string> { "" };
    };
}

<div class="container">
    <h2 class="mt-4 mb-4">Quản Lý Sản Phẩm</h2>

    <a href="@Url.Action("ThemSanPham")" class="btn btn-primary mb-3">Thêm Sản Phẩm Mới</a>

    <!-- Form tìm kiếm -->
    @using (Html.BeginForm("QuanLySanPham", "Admin", FormMethod.Get))
    {
        <div class="row g-2 mb-2">
            <div class="col-md-8">
                <input type="text" name="searchTerm" class="form-control" placeholder="Tìm kiếm sản phẩm..." value="@ViewBag.SearchTerm" />
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button class="btn btn-outline-secondary flex-grow-1" type="submit">Tìm kiếm</button>
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="@(activeFilters.Any() ? "true" : "false")">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
        </div>
        <div class="collapse @(activeFilters.Any() ? "show" : "")" id="advancedFilters">
            <div class="card card-body mb-3">
                <h5 class="mb-3">Bộ lọc thông số kỹ thuật</h5>
                @if (specDefinitions.Any())
                {
                    <div class="row g-3">
                        @foreach (var spec in specDefinitions)
                        {
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">@spec.TenThongSo @if (!string.IsNullOrWhiteSpace(spec.DonVi))
                                {<small class="text-muted">(@spec.DonVi)</small>}</label>
                                @{
                                    var specValues = GetSpecValues(spec.TenThongSo);
                                    var currentFilterValue = activeFilters.ContainsKey(spec.MaThongSo) ? activeFilters[spec.MaThongSo] : string.Empty;
                                }
                                @if (specValues.Count > 1)
                                {
                                    <select name="spec_@spec.MaThongSo" class="form-control">
                                        @foreach (var val in specValues)
                                        {
                                            <option value="@val" @(val == currentFilterValue ? "selected" : "")>@(string.IsNullOrEmpty(val) ? "-- Tất cả --" : val)</option>
                                        }
                                    </select>
                                }
                                else
                                {
                                    <input type="text"
                                           name="spec_@spec.MaThongSo"
                                           class="form-control"
                                           value="@currentFilterValue"
                                           placeholder="Nhập giá trị..." />
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">Chưa có thông số kỹ thuật nào để lọc.</p>
                }
                <div class="mt-3">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-filter me-2"></i>Áp dụng
                    </button>
                    <a href="@Url.Action("QuanLySanPham")" class="btn btn-outline-secondary ms-2">Xóa bộ lọc</a>
                </div>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-body">
            <table class="table table-hover table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Mã Sản Phẩm</th>
                        <th scope="col">Tên Sản Phẩm</th>
                        <th scope="col">Hình Ảnh</th>
                        <th scope="col">Mô Tả</th>
                        <th scope="col">Giá</th>
                        <th scope="col">Giá mới</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col">Hành Động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.MaSanPham</td>
                            <td>@item.TenSanPham</td>
                            <td>
                                <img src="~/assets/images/product/@item.MaSanPham/@item.HinhAnh" alt="Sản Phẩm" style="width: 100px; height: auto;" />
                            </td>
                            <td>@item.MoTa</td>
                            <td>@item.Gia.ToString("N0") đ</td>

                            @if (item.GiaMoi != null)
                            {
                                <td>
                                    @item.GiaMoi.ToString("N0") đ
                                </td>
                            }
                            else
                            {
                                <td>
                                    <span>Không có giảm giá</span>
                                </td>
                            }

                            <td>
                                <span class="badge @(item.TrangThai == true ? "bg-success" : "bg-danger")">
                                    @(item.TrangThai == true ? "Hoạt động" : "Ngừng hoạt động")
                                </span>
                            </td>
                            <td>
                                <a href="@Url.Action("SuaSanPham", new { id = item.MaSanPham })" class="btn btn-warning btn-sm">Sửa</a>
                                <a href="@Url.Action("ChiTietSanPhamAdmin", new { id = item.MaSanPham })" class="btn btn-info btn-sm">Chi tiết</a>
                                @if (item.TrangThai == true) // Nếu sản phẩm đang mở bán
                                {
                                    <a href="@Url.Action("CapNhatTrangThaiSP", new { id = item.MaSanPham, status = false })" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc chắn muốn ngưng bán sản phẩm này?');">Ngưng Bán</a>
                                }
                                else // Nếu sản phẩm đang ngưng bán
                                {
                                    <a href="@Url.Action("CapNhatTrangThaiSP", new { id = item.MaSanPham, status = true })" class="btn btn-success btn-sm" onclick="return confirm('Bạn có chắc chắn muốn mở bán sản phẩm này?');">Mở Bán</a>
                                }
                                <form action="@Url.Action("NgungGiamGia", new { id = item.MaSanPham })" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Bạn có chắc chắn muốn ngưng giảm giá sản phẩm này?');">Ngưng Giảm Giá</button>
                                </form>
                                <!-- Thêm nút Giảm Giá -->
                                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#giamGiaModal" data-id="@item.MaSanPham" data-tensp="@item.TenSanPham" data-gia="@item.Gia">Giảm Giá</button>

                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
            @{
                var queryString = Request.QueryString != null ? Request.QueryString.ToString() : string.Empty;
                var baseQuery = HttpUtility.ParseQueryString(queryString);
            }
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                baseQuery["page"] = i.ToString();
                var pageUrl = Url.Action("QuanLySanPham") + "?" + baseQuery.ToString();
                <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                    <a class="page-link" href="@pageUrl">@i</a>
                </li>
            }
        </ul>
    </nav>
</div>
<!-- Modal Giảm Giá -->
<div class="modal fade" id="giamGiaModal" tabindex="-1" role="dialog" aria-labelledby="giamGiaModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="giamGiaModalLabel">Giảm Giá Sản Phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="giamGiaForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="MaSanPham" name="MaSanPham" />
                    <div class="form-group">
                        <label for="TenSanPham">Tên Sản Phẩm:</label>
                        <input type="text" class="form-control" id="TenSanPham" readonly />
                    </div>
                    <div class="form-group">
                        <label for="Gia">Giá Hiện Tại:</label>
                        <input type="text" class="form-control" id="Gia" readonly />
                    </div>
                    <div class="form-group">
                        <label for="GiaMoi">Giá Mới:</label>
                        <input type="number" class="form-control" id="GiaMoi" name="GiaMoi" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Cập Nhật Giá</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
        $(document).ready(function () {
            // Khi modal mở
            $('#giamGiaModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // Lấy nút nhấn để mở modal
                var id = button.data('id'); // Lấy id sản phẩm
                var tenSanPham = button.data('tensp'); // Lấy tên sản phẩm
                var gia = button.data('gia'); // Lấy giá hiện tại

                // Cập nhật giá trị trong modal
                var modal = $(this);
                modal.find('#MaSanPham').val(id);
                modal.find('#TenSanPham').val(tenSanPham);
                modal.find('#Gia').val(gia.toLocaleString('vi-VN') + " đ"); // Định dạng giá
            });

            // Xử lý submit form giảm giá
            $('#giamGiaForm').submit(function (e) {
                e.preventDefault(); // Ngăn chặn reload trang

                var maSanPham = $('#MaSanPham').val();

                var giaMoi = $('#GiaMoi').val();

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GiamGia", "Admin")', // Thay đổi tên controller nếu cần
                    data: { MaSanPham: maSanPham, GiaMoi: giaMoi },
                    success: function (response) {
                        alert('Cập nhật giá thành công!');
                        location.reload(); // Reload lại trang
                    },
                    error: function () {
                        alert('Cập nhật giá thất bại!');
                    }
                });
            });
        });
</script>