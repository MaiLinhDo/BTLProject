@{
    ViewBag.Title = "Danh sách Bảo hành của tôi";
    Layout = "~/Views/Shared/_LayoutHome.cshtml";
}

<style>
    .breadcrumb-area {
        background: #f8f9fa;
        padding: 40px 0;
        border-bottom: 1px solid #e9ecef;
    }
    .breadcrumb-content {
        text-align: center;
    }
    .breadcrumb-content h2 {
        font-size: 1.75rem;
        font-weight: 600;
        margin-bottom: 16px;
        color: #212529;
    }
    .breadcrumb-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
    }
    .breadcrumb-content ul li {
        color: #6c757d;
    }
    .breadcrumb-content ul li a {
        color: #0d6efd;
        text-decoration: none;
    }
    .breadcrumb-content ul li::after {
        content: '/';
        margin-left: 12px;
        color: #dee2e6;
    }
    .breadcrumb-content ul li:last-child::after {
        display: none;
    }
    .page-content {
        padding: 60px 0;
        background: #ffffff;
        min-height: 80vh;
    }

    /* Navigation tabs */
    .warranty-tabs {
        margin-bottom: 30px;
    }
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-weight: 500;
        padding: 12px 24px;
        transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active {
        background: none;
        border-bottom: 3px solid #0d6efd;
        color: #0d6efd;
    }
    .nav-tabs .nav-link:hover {
        border-bottom: 3px solid #0d6efd;
        color: #0d6efd;
    }

    .warranty-item {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease;
    }
    .warranty-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .warranty-header {
        background: #f8f9fa;
        padding: 16px 24px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .warranty-id {
        font-weight: 600;
        color: #212529;
        margin: 0;
    }
    .warranty-date {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 0;
    }
    .warranty-body {
        padding: 20px 24px;
    }
    .warranty-product {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }
    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
    .product-info {
        flex: 1;
    }
    .product-name {
        font-weight: 600;
        color: #212529;
        margin-bottom: 8px;
        font-size: 1.1rem;
    }
    .product-details {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }
    .warranty-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        border-top: 1px solid #e9ecef;
    }
    .status-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .warranty-validity {
        font-size: 0.85rem;
        font-weight: 500;
    }
    .warranty-valid {
        color: #28a745;
    }
    .warranty-expired {
        color: #dc3545;
    }
    .warranty-warning {
        color: #ffc107;
    }
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .btn-create-warranty {
        background: #28a745;
        color: white;
        border: 1px solid #28a745;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.15s ease;
    }
    .btn-create-warranty:hover {
        background: #218838;
        border-color: #1e7e34;
        color: white;
        text-decoration: none;
    }
    .btn-view-warranty {
        background: #0d6efd;
        color: white;
        border: 1px solid #0d6efd;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.15s ease;
    }
    .btn-view-warranty:hover {
        background: #0b5ed7;
        border-color: #0a58ca;
        color: white;
        text-decoration: none;
    }
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #dee2e6;
    }
    .empty-state h5 {
        margin-bottom: 16px;
        color: #495057;
    }
    .pagination {
        justify-content: center;
        margin-top: 40px;
    }
    .loading {
        text-align: center;
        padding: 40px;
    }
    @@media (max-width: 768px) {
        .warranty-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        .warranty-body {
            padding: 16px 20px;
        }
        .warranty-product {
            flex-direction: column;
            text-align: center;
        }
        .product-image {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        .warranty-status {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }
        .action-buttons {
            justify-content: center;
        }
    }
</style>

<div class="breadcrumb-area">
    <div class="container">
        <div class="breadcrumb-content">
            <h2>Danh sách Bảo hành của tôi</h2>
            <ul>
                <li><a href="@Url.Action("Index","Home")">Trang chủ</a></li>
                <li><a href="@Url.Action("DonHangCuaToi","Home")">Đơn hàng của tôi</a></li>
                <li class="active">Bảo hành</li>
            </ul>
        </div>
    </div>
</div>

<main class="page-content">
    <div class="container">
        <!-- Navigation tabs -->
        <div class="warranty-tabs">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="auto-warranty-tab" data-bs-toggle="tab" href="#auto-warranty" role="tab">
                        <i class="fas fa-shield-alt"></i> Bảo hành tự động
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="warranty-requests-tab" data-bs-toggle="tab" href="#warranty-requests" role="tab">
                        <i class="fas fa-file-medical"></i> Phiếu bảo hành đã tạo
                    </a>
                </li>
            </ul>
        </div>

        <div class="tab-content">
            <!-- Tab Bảo hành tự động -->
            <div class="tab-pane fade show active" id="auto-warranty" role="tabpanel">
                <div id="autoWarrantyContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Đang tải danh sách bảo hành...</p>
                    </div>
                </div>
            </div>

            <!-- Tab Phiếu bảo hành -->
            <div class="tab-pane fade" id="warranty-requests" role="tabpanel">
                <div id="warrantyRequestsContent">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Đang tải phiếu bảo hành...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lấy maTaiKhoan từ ViewBag và định nghĩa như một biến JavaScript
    const maTaiKhoan = '@ViewBag.MaTaiKhoan';

    // Load bảo hành tự động khi trang được tải
    loadAutoWarranties(1);

    // Handle tab switching
    document.getElementById('warranty-requests-tab').addEventListener('click', function() {
        loadWarrantyRequests(1);
    });

    // Load bảo hành tự động
    async function loadAutoWarranties(page = 1) {
        try {
            const response = await fetch('http://127.0.0.1:5000/api/get_bao_hanh_tu_dong', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    maTaiKhoan: parseInt(maTaiKhoan),
                    page: page,
                    pageSize: 10
                })
            });

            const data = await response.json();

            if (data.success) {
                displayAutoWarranties(data.baoHanhList, data.currentPage, data.totalPages);
            } else {
                showError('Không thể tải danh sách bảo hành tự động');
            }
        } catch (error) {
            console.error('Error loading auto warranties:', error);
            showError('Lỗi kết nối khi tải danh sách bảo hành');
        }
    }

    // Load phiếu bảo hành đã tạo
    async function loadWarrantyRequests(page = 1) {
        try {
            const response = await fetch('http://127.0.0.1:5000/api/get_phieu_bao_hanh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    MaTaiKhoan: parseInt(maTaiKhoan),
                    Page: page,
                    PageSize: 10
                })
            });

            const data = await response.json();

            if (data.success) {
                displayWarrantyRequests(data.phieuBaoHanh, data.currentPage, data.totalPages);
            } else {
                showError('Không thể tải danh sách phiếu bảo hành');
            }
        } catch (error) {
            console.error('Error loading warranty requests:', error);
            showError('Lỗi kết nối khi tải phiếu bảo hành');
        }
    }

    // Hiển thị bảo hành tự động
    function displayAutoWarranties(warranties, currentPage, totalPages) {
        const container = document.getElementById('autoWarrantyContent');

        if (!warranties || warranties.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shield-alt"></i>
                    <h5>Chưa có bảo hành tự động nào</h5>
                    <p>Bảo hành tự động sẽ được tạo khi bạn nhận hàng thành công.</p>
                    <a href="/Home/DonHangCuaToi" class="btn btn-primary">
                        <i class="fas fa-shopping-bag"></i> Xem đơn hàng của tôi
                    </a>
                </div>
            `;
            return;
        }

        let html = '';
        warranties.forEach(warranty => {
            const warrantyStatus = warranty.ConBaoHanh ?
                (warranty.SoNgayConLai > 30 ?
                    `<span class="warranty-validity warranty-valid"><i class="fas fa-shield-alt"></i> Còn ${warranty.SoNgayConLai} ngày bảo hành</span>` :
                    `<span class="warranty-validity warranty-warning"><i class="fas fa-shield-alt"></i> Còn ${warranty.SoNgayConLai} ngày bảo hành</span>`
                ) :
                `<span class="warranty-validity warranty-expired"><i class="fas fa-shield-alt"></i> Hết hạn bảo hành</span>`;

            html += `
                <div class="warranty-item">
                    <div class="warranty-header">
                        <div>
                            <h5 class="warranty-id">Bảo hành tự động #${warranty.MaBaoHanh}</h5>
                            <p class="warranty-date">Bắt đầu: ${formatDate(warranty.NgayBatDau)}</p>
                        </div>
                        <div class="text-right">
                            <span class="badge ${warranty.TrangThai === 'Hoạt động' ? 'bg-success' : 'bg-secondary'}">
                                ${warranty.TrangThai}
                            </span>
                        </div>
                    </div>
                    <div class="warranty-body">
                        <div class="warranty-product">
                            <img src="/assets/images/product/${warranty.MaSanPham}/${warranty.HinhAnh || '/Content/images/no-image.png'}"
                                 alt="Product" class="product-image">
                            <div class="product-info">
                                <h6 class="product-name">${warranty.TenSanPham}</h6>
                                <div class="product-details">Số lượng: ${warranty.SoLuong}</div>
                                <div class="product-details">Đơn hàng: #${warranty.MaDonHang}</div>
                                <div class="product-details">Ngày mua: ${formatDate(warranty.NgayBatDau)}</div>
                            </div>
                        </div>
                        <div class="warranty-status">
                            <div class="status-info">
                                ${warrantyStatus}
                                <small class="text-muted">Hết hạn: ${formatDate(warranty.NgayKetThuc)}</small>
                            </div>
                            <div class="action-buttons">
                                ${warranty.ConBaoHanh ?
                                    `<a href="/BaoHanh/TaoBaoHanh?maDonHang=${warranty.MaDonHang}&maSanPham=${warranty.MaSanPham}"
                                       class="btn-create-warranty">
                                        <i class="fas fa-plus"></i> Tạo phiếu bảo hành
                                    </a>` :
                                    '<span class="text-muted">Không thể tạo phiếu</span>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        // Add pagination
        if (totalPages > 1) {
            html += generatePagination(currentPage, totalPages, 'loadAutoWarranties');
        }

        container.innerHTML = html;
    }

    // Hiển thị phiếu bảo hành đã tạo
    function displayWarrantyRequests(warranties, currentPage, totalPages) {
        const container = document.getElementById('warrantyRequestsContent');
        const baseUrl = '@Url.Action("ChiTietBaoHanhUser", "BaoHanh")';
        if (!warranties || warranties.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-medical"></i>
                    <h5>Chưa có phiếu bảo hành nào</h5>
                    <p>Bạn chưa tạo phiếu bảo hành nào. Hãy tạo phiếu từ bảo hành tự động.</p>
                </div>
            `;
            return;
        }

        let html = '';
        warranties.forEach(warranty => {
            const statusClass = getStatusBadgeClass(warranty.TrangThai);
            const warrantyStatus = warranty.ConBaoHanh ?
                (warranty.SoNgayConLai > 30 ?
                    `<span class="warranty-validity warranty-valid"><i class="fas fa-shield-alt"></i> Còn ${warranty.SoNgayConLai} ngày bảo hành</span>` :
                    `<span class="warranty-validity warranty-warning"><i class="fas fa-shield-alt"></i> Còn ${warranty.SoNgayConLai} ngày bảo hành</span>`
                ) :
                `<span class="warranty-validity warranty-expired"><i class="fas fa-shield-alt"></i> Hết hạn bảo hành</span>`;

            html += `
                <div class="warranty-item">
                    <div class="warranty-header">
                        <div>
                            <h5 class="warranty-id">Phiếu Bảo hành #${warranty.MaPhieuBH}</h5>
                            <p class="warranty-date">Tạo ngày: ${formatDate(warranty.NgayTao)}</p>
                        </div>
                        <div class="text-right">
                            <span class="badge ${statusClass}">${warranty.TrangThai}</span>
                        </div>
                    </div>
                    <div class="warranty-body">
                        <div class="warranty-product">
                            <img src="/assets/images/product/${warranty.MaSanPham}/${warranty.HinhAnhSP || '/Content/images/no-image.png'}"
                                 alt="Product" class="product-image">
                            <div class="product-info">
                                <h6 class="product-name">${warranty.TenSanPham}</h6>
                                <div class="product-details">Số lượng BH: ${warranty.SoLuongBH}</div>
                                <div class="product-details">Ngày mua: ${formatDate(warranty.NgayBatDauBH)}</div>
                                <div class="product-details">Đơn hàng: #${warranty.MaDonHang}</div>
                                ${warranty.LyDoTuChoi ?
                                    `<div class="product-details text-danger"><strong>Lý do từ chối:</strong> ${warranty.LyDoTuChoi}</div>` : ''
                                }
                            </div>
                        </div>
                        <div class="warranty-status">
                            <div class="status-info">
                                ${warrantyStatus}
                                <small class="text-muted">Hạn bảo hành: ${formatDate(warranty.NgayKetThucBH)}</small>
                            </div>
                            <div class="action-buttons">
                               <a href="${baseUrl}/${warranty.MaPhieuBH}" class="btn-view-warranty">
       <i class="fas fa-eye"></i> Xem chi tiết
   </a>

                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        // Add pagination
        if (totalPages > 1) {
            html += generatePagination(currentPage, totalPages, 'loadWarrantyRequests');
        }

        container.innerHTML = html;
    }

    // Helper functions
    function getStatusBadgeClass(status) {
        const statusClasses = {
            'Chờ xử lý': 'bg-warning',
            'Đã duyệt': 'bg-info',
            'Chờ lấy hàng bảo hành': 'bg-primary',
            'Đang vận chuyển': 'bg-info',
            'Đang bảo hành': 'bg-warning',
            'Bảo hành hoàn tất': 'bg-success',
            'Chờ trả hàng': 'bg-primary',
            'Đã trả hàng': 'bg-success',
            'Hoàn tất': 'bg-success',
            'Từ chối': 'bg-danger'
        };
        return statusClasses[status] || 'bg-secondary';
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toLocaleDateString('vi-VN');
    }

    function generatePagination(currentPage, totalPages, functionName) {
        if (totalPages <= 1) return '';

        let html = '<nav aria-label="Pagination"><ul class="pagination">';

        for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="${functionName}(${i})">${i}</a>
                     </li>`;
        }

        html += '</ul></nav>';
        return html;
    }

    function showError(message) {
        console.error(message);
        // You can implement a better error display here
        alert(message);
    }

    // Expose functions to global scope for pagination onclick handlers
    window.loadAutoWarranties = loadAutoWarranties;
    window.loadWarrantyRequests = loadWarrantyRequests;
});
</script>